<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Шинка - Онлайн запись</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 500px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
            color: #333;
        }
        .header h1 {
            font-size: 2.5rem;
            color: #667eea;
            margin-bottom: 10px;
        }
        .form-group {
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
            font-size: 14px;
        }
        input[type="text"],
        input[type="tel"],
        input[type="date"],
        input[type="time"],
        select,
        textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 10px;
            font-size: 14px;
            font-family: inherit;
            transition: border-color 0.3s;
        }
        input[type="text"]:focus,
        input[type="tel"]:focus,
        input[type="date"]:focus,
        input[type="time"]:focus,
        select:focus,
        textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        .time-slots {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin-top: 10px;
        }
        .time-slot {
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
            font-size: 13px;
        }
        .time-slot:hover {
            border-color: #667eea;
            background: #f0f4ff;
        }
        .time-slot.selected {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }
        .time-slot.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .services {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 10px;
        }
        .service-item {
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s;
            font-size: 13px;
        }
        .service-item:hover {
            border-color: #667eea;
            background: #f0f4ff;
        }
        .service-item.selected {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }
        .submit-btn {
            width: 100%;
            padding: 16px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            margin-top: 20px;
            transition: transform 0.3s;
        }
        .submit-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }
        .submit-btn:active {
            transform: translateY(0);
        }
        .success {
            background: #10b981;
            color: white;
            padding: 16px;
            border-radius: 10px;
            margin-top: 20px;
            text-align: center;
            display: none;
        }
        .error {
            background: #ef4444;
            color: white;
            padding: 12px;
            border-radius: 10px;
            margin-top: 10px;
            font-size: 14px;
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ШИНКА</h1>
            <p>Онлайн запись на услуги</p>
        </div>

        <form id="bookingForm">
            <!-- ИМЯ -->
            <div class="form-group">
                <label for="name">Имя *</label>
                <input type="text" id="name" placeholder="Иван" required>
            </div>

            <!-- ТЕЛЕФОН -->
            <div class="form-group">
                <label for="phone">Телефон *</label>
                <input type="tel" id="phone" placeholder="+7 (999) 999-99-99" required>
            </div>

            <!-- ДАТА -->
            <div class="form-group">
                <label for="date">Дата *</label>
                <input type="date" id="date" required>
            </div>

            <!-- ВРЕМЯ (30-минутные интервалы) -->
            <div class="form-group">
                <label>Время (30 минут) *</label>
                <div class="time-slots" id="timeSlots"></div>
                <input type="hidden" id="selectedTime">
            </div>

            <!-- УСЛУГА -->
            <div class="form-group">
                <label>Услуга *</label>
                <div class="services" id="services"></div>
                <input type="hidden" id="selectedService">
            </div>

            <!-- КОММЕНТАРИЙ -->
            <div class="form-group">
                <label for="comment">Комментарий</label>
                <textarea id="comment" rows="3" placeholder="Марка авто, размер шин..."></textarea>
            </div>

            <!-- КНОПКА -->
            <button type="submit" class="submit-btn">Подтвердить запись</button>

            <!-- СООБЩЕНИЯ -->
            <div class="success" id="success">✓ Запись успешно создана!</div>
            <div class="error" id="error"></div>
        </form>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        const supabaseUrl = 'https://ahdcfaaczxbkbqldzell.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFoZGNmYWFjenhia2JxbGR6ZWxsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUxMjM4NjAsImV4cCI6MjA4MDY5OTg2MH0.Ym239Oba2nmyU94qK8cf9-NtWbO876-eG2J_WtA7a-0';
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

        const SERVICES = [
            'Сезонная замена шин',
            'Балансировка колёс',
            'Ремонт шин',
            'Диагностика кондиционера',
            'Заправка кондиционера',
            'Проточка тормозных дисков'
        ];

        let selectedTime = null;
        let selectedService = null;

        // Инициализация
        document.addEventListener('DOMContentLoaded', () => {
            initializeDate();
            renderServices();
            document.getElementById('date').addEventListener('change', generateTimeSlots);
            document.getElementById('bookingForm').addEventListener('submit', handleSubmit);
        });

        // 1. Установить минимальную дату на сегодня
        function initializeDate() {
            const today = new Date().toISOString().split('T')[0];
            const dateInput = document.getElementById('date');
            dateInput.min = today;
            dateInput.value = today;
            generateTimeSlots();
        }

        // 2. Генерировать слоты времени (30-минутные интервалы)
        function generateTimeSlots() {
            const container = document.getElementById('timeSlots');
            const dateInput = document.getElementById('date').value;
            container.innerHTML = '';
            selectedTime = null;

            if (!dateInput) return;

            const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate()).toISOString().split('T')[0];
            const isToday = dateInput === today;
            const currentHour = now.getHours();
            const currentMin = now.getMinutes();

            // Рабочие часы: 9:00-20:00 (пн-пт), 10:00-18:00 (сб), 10:00-16:00 (вс)
            const selectedDate = new Date(dateInput + 'T00:00:00');
            const dayOfWeek = selectedDate.getDay();
            let startHour, endHour;

            if (dayOfWeek === 0) { startHour = 10; endHour = 16; } // Вс
            else if (dayOfWeek === 6) { startHour = 10; endHour = 18; } // Сб
            else { startHour = 9; endHour = 20; } // Пн-Пт

            // Генерируем слоты по 30 минут
            for (let h = startHour; h < endHour; h++) {
                for (let m = 0; m < 60; m += 30) {
                    const timeStr = String(h).padStart(2, '0') + ':' + String(m).padStart(2, '0');
                    
                    // Если сегодня, пропускаем прошедшее время
                    if (isToday && (h < currentHour || (h === currentHour && m <= currentMin))) {
                        continue;
                    }

                    const btn = document.createElement('div');
                    btn.className = 'time-slot';
                    btn.textContent = timeStr;
                    btn.onclick = () => selectTime(btn, timeStr);
                    container.appendChild(btn);
                }
            }
        }

        // 3. Выбор времени
        function selectTime(element, time) {
            document.querySelectorAll('.time-slot').forEach(el => el.classList.remove('selected'));
            element.classList.add('selected');
            selectedTime = time;
            document.getElementById('selectedTime').value = time;
        }

        // 4. Рендерить услуги
        function renderServices() {
            const container = document.getElementById('services');
            container.innerHTML = '';
            SERVICES.forEach(service => {
                const btn = document.createElement('div');
                btn.className = 'service-item';
                btn.textContent = service;
                btn.onclick = () => selectService(btn, service);
                container.appendChild(btn);
            });
        }

        // 5. Выбор услуги
        function selectService(element, service) {
            document.querySelectorAll('.service-item').forEach(el => el.classList.remove('selected'));
            element.classList.add('selected');
            selectedService = service;
            document.getElementById('selectedService').value = service;
        }

        // 6. Отправка формы
        async function handleSubmit(e) {
            e.preventDefault();

            const name = document.getElementById('name').value.trim();
            const phone = document.getElementById('phone').value.trim();
            const date = document.getElementById('date').value;
            const time = selectedTime;
            const service = selectedService;
            const comment = document.getElementById('comment').value.trim();

            // Валидация
            if (!name || !phone || !date || !time || !service) {
                showError('Заполните все обязательные поля!');
                return;
            }

            try {
                // Сохраняем в Supabase
                const { error } = await supabase
                    .from('bookings')
                    .insert([{ name, phone, date, time, service, comment }]);

                if (error) throw error;

                // Успех
                document.getElementById('bookingForm').reset();
                selectedTime = null;
                selectedService = null;
                document.querySelectorAll('.time-slot.selected, .service-item.selected').forEach(el => el.classList.remove('selected'));
                
                showSuccess();
                generateTimeSlots();
            } catch (error) {
                console.error(error);
                showError('Ошибка отправки. Попробуйте позже.');
            }
        }

        function showError(msg) {
            const errorEl = document.getElementById('error');
            errorEl.textContent = msg;
            errorEl.style.display = 'block';
            setTimeout(() => errorEl.style.display = 'none', 4000);
        }

        function showSuccess() {
            const successEl = document.getElementById('success');
            successEl.style.display = 'block';
            setTimeout(() => successEl.style.display = 'none', 4000);
        }
    </script>
</body>
</html>
